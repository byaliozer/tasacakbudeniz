<analysis>
**original_problem_statement**: The user wants to create an interactive quiz mobile application for the Turkish TV series Taşacak Bu Deniz. After initial development, the user requested a complete redesign of the game's structure, UI, and scoring logic.

**PRODUCT REQUIREMENTS**:
- **Game Modes**:
  - **Episode Mode**: 14+ episodes, 25 questions each, 20-second timer, 3 lives. A wrong answer costs a life. The game ends when lives run out.
  - **Mixed Mode**: An endless mode with all questions shuffled. The run ends when 3 lives are lost.
- **Scoring**:
  - **Episode Mode**: Saves the player's *best score* for each episode. The  is the sum of all best episode scores.
  - **Mixed Mode**: Saves the player's single *best run score*.
  - **Speed Bonus**: +5 points for answering within the first 5 seconds.
- **Leaderboards**: A single screen with 3 tabs:
  - **General Leaderboard**: Ranks players by .
  - **Episode Leaderboard**: A dropdown to view best scores for a specific episode.
  - **Mixed Mode Leaderboard**: Ranks players by their best run score in mixed mode.
- **UI/UX**:
  - **Main Menu**: Redesigned with a top banner, two large buttons for game modes, and two smaller buttons at the bottom for Leaderboard and Settings.
  - **Settings**: Sound On/Off, Vibration On/Off, Change Username, and links for Privacy Policy and Contact.
  - **Username**: Must be requested only once on the first app launch. Scores are saved automatically afterward.
  - **Quiz Screen**: Must have an exit button with a confirmation modal that pauses the game.
  - **Dynamic Episodes**: The app must dynamically load all episodes from a Google Sheet, including handling a locked state.
- **Monetization**:
  - Integrate Google AdMob to display a banner ad on most screens.
  - Show an interstitial (full-screen) ad on game over.

**User's preferred language**: Türkçe

**what currently exists?**
A full-stack application with a FastAPI backend and an Expo (React Native) frontend. A major redesign has been implemented to meet the new product requirements, including new game modes, a new backend scoring system, a redesigned UI, and a one-time username entry flow. The backend has also been updated to dynamically load any number of episodes from the connected Google Sheet.

However, the latest native APK tested by the user has critical bugs preventing gameplay and monetization.

**Last working item**:
-   **Last item agent was working**: The agent was performing a final bug bash to address two critical issues reported by the user via a screen recording of the native app:
    1.  The game does not end after 3 wrong answers.
    2.  Neither banner nor interstitial ads are displaying.
    The agent implemented fixes for both issues, culminating in an update to the interstitial ad logic in .
-   **Status**: USER VERIFICATION PENDING
-   **Agent Testing Done**: N (Fixes have been applied, but they address native-only bugs and have not been verified on a new APK).
-   **Which testing method agent to use?** A new native APK needs to be built using **EAS Build**. The user must then perform manual testing on the device.
-   **User Testing Done**: Y (The user provided a screen recording demonstrating the critical bugs in the previous build).

**All Pending/In progress Issue list**:
-   **Issue 1: (P0) Game does not end after 3 wrong answers on native build.**
    -   **Description**: In the native app, when a player makes three wrong answers, their lives decrease to zero, but the game does not end and transition to the result screen as it should. The player gets stuck in the quiz.
    -   **Attempted fixes**: The agent identified a potential race condition/closure issue where the  state was not being read correctly within the  function. The latest fix involved introducing a  () in  to reliably track the current number of lives and trigger the game-over condition.
    -   **Next debug checklist**:
        1.  Instruct the user to build a new APK and test this scenario by deliberately answering incorrectly three times.
        2.  If the issue persists, connect the device to a computer and inspect the native logs ( for Android) for the console logs added in  to trace the values of  and .
        3.  Verify the  function is being called and that  is being executed.
    -   **Why fix this issue and what will be achieved with the fix?**: This bug breaks the core gameplay loop, making both Episode and Mixed modes unplayable and preventing scores from being saved.
    -   **Status**: USER VERIFICATION PENDING
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Frontend (via new APK).
    -   **Blocked on other issue**: None

-   **Issue 2: (P1) Google AdMob ads (Banner & Interstitial) are not displaying on native build.**
    -   **Description**: The banner ad shows a placeholder text (Reklam Alanı) instead of a real or test ad. The interstitial ad, which should appear on game over, is never shown.
    -   **Attempted fixes**: The agent refactored the ad implementation to use platform-specific files ( and ), which is the correct approach. In the last attempt, the agent updated  and  to use official Google test ad unit IDs and to display error messages on-screen if an ad fails to load.
    -   **Next debug checklist**:
        1.  After building the new APK, check if test ads are now visible.
        2.  If not, check the device logs () for any specific error messages from the  library.
        3.  Double-check that the  file contains the correct .
    -   **Why fix this issue and what will be achieved with the fix?**: Monetization is a primary requirement for the application.
    -   **Status**: USER VERIFICATION PENDING
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Frontend (via new APK).
    -   **Blocked on other issue**: None

-   **Issue 3: (P2) Production backend deployment is outdated.**
    -   **Description**: The production backend () runs an older version of the code with a different API schema than the local development environment. This has caused numerous discrepancies between web preview testing and native APK behavior.
    -   **Attempted fixes**: The agent implemented a robust workaround in . The code now attempts to call the new API endpoints and, on failure, falls back to the old endpoints, normalizing the data so the rest of the app receives a consistent data structure.
    -   **Next debug checklist**: This is a temporary mitigation. The permanent solution is to update the production backend deployment to match the latest code in .
    -   **Why fix this issue and what will be achieved with the fix?**: A unified API schema simplifies development and eliminates a major source of bugs.
    -   **Status**: IN PROGRESS (Mitigated by a workaround).
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Backend (deployment).
    -   **Blocked on other issue**: None

**In progress Task List**:
None. All current work is categorized under the issues above.

**Upcoming and Future Tasks**
- **Upcoming Tasks**:
    - **P1: Verify UI/UX and Animations**: After the critical bugs are fixed, a full review of the UI/UX against the redesign document (Message 168) is needed. This includes verifying animations (shake on wrong answer, confetti, score bounce) and sound effects ( implementation).
    - **P2: Implement Vibration**: The Settings screen has a toggle for Vibration, but the functionality () is not yet implemented in the quiz screen.
- **Future Tasks**:
    - **Refine Leaderboard**: Ensure the YOUR POSITION feature on the leaderboard works correctly.
    - **Full Sound Design**: Test and confirm that all specified sounds (click, ding, buzz, timer tick, etc.) are present and controlled by the settings toggle.

**Completed work in this session**
- **Complete Game Redesign**: The entire application was refactored to introduce Episode and Mixed modes, a new scoring system (best-of and global scores), and a 3-tab leaderboard.
- **Backend Overhaul**:  was rewritten to support the new game logic, database schemas, and API endpoints. It now also dynamically parses episodes and questions from the Google Sheet, handling different CSV headers.
- **Frontend Overhaul**: All screens were either created or rewritten: ,  (main menu), , , , , and .
- **Dynamic Episode System**: The backend and frontend were updated to dynamically fetch and display any number of episodes from Google Sheets, including visual indicators and logic for locked episodes.
- **Critical Bug Fixes**:
    - **Quiz Logic**: Fixed the always correct answer bug by making the frontend resilient to two different API response formats (from the outdated production backend and the new local backend).
    - **Life System**: Refactored the game-over logic using  to prevent race conditions that stopped the game from ending.
    - **Ad System**: Re-architected the AdMob implementation to use platform-specific files ( and ), resolving web preview crashes and setting up the correct structure for native ads.
    - **UI/UX**: Implemented the new main menu design, added banner images, created the quiz exit modal, and fixed the splash screen appearance.

**Earlier issues found/mentioned but not fixed**
All known issues are listed in the **All Pending/In progress Issue list**.

**Known issue recurrence from previous fork**
N/A

**Code Architecture**


**Key Technical Concepts**
- **Frontend**: React Native, Expo, Expo Router, TypeScript
- **Backend**: Python, FastAPI
- **Database**: MongoDB
- **State Management**: , ,  (for resolving state closure issues).
- **Native Specifics**:
    - **Platform-specific files**: Using  and  extensions to isolate native-only code (like ).
    - **EAS Build**: Used for creating native APKs.
    - ****: For native audio playback.
- **API Resilience**: Client-side data normalization in  to handle multiple backend API versions simultaneously.

**key DB schema**
-   **users**: 
-   **episode_scores**:  (stores only the best score)
-   **mixed_scores**:  (stores only the best score)
-   **leaderboard**: (This collection appears to be deprecated by the new design, which builds leaderboards by aggregating the  and  collections).

**changes in tech stack**
-    was added for persistent user storage (username).

**All files of reference**
-   : Contains the critical life system logic ( fix).
-   : Banner ad implementation for native.
-   : Interstitial ad implementation for native.
-   : Contains the crucial fallback logic to support the outdated production backend.
-   : The completely rewritten backend logic.
-   : Configuration for splash screen and AdMob App ID.
-   : Configuration for EAS Build.

**Areas that need refactoring**:
- The API fallback logic in  is a temporary measure. Once the production backend is updated, this complex logic should be removed to simplify the code.

**key api endpoints**
-   : Create/get user.
-   : Get list of episodes with user's best scores.
-   : Get questions for a quiz (supports , , ).
-   : Submit a score for either episode or mixed mode.
-   : Get leaderboard data (supports  and ).

**Critical Info for New Agent**
-   **PRIORITY 1**: You must guide the user to build a new APK to verify the latest fixes for the **life system** and **AdMob ads**. These are native-only bugs.
-   **DO NOT TRUST WEB PREVIEW**: The web preview is unreliable for testing core gameplay and native features like ads due to the outdated production backend and platform differences. All critical testing must be done on a native APK.
-   **Production Backend is Outdated**: The live API () is different from the local one. The frontend has a workaround in , but be mindful that any new backend features will not work in the APK until the production server is updated.
-   **Ad Implementation**: Ads are implemented using platform-specific files ( / ). To edit native ad behavior, you must modify the  files in  and .

**documents created in this job**
None.

**Last 10 User Messages and any pending HUMAN messages**
1.  **User**: I want to update the settings screen links for privacy and contact. (Request fulfilled).
2.  **User**: Reports 4 new bugs in the native build: 1) Blue splash screen, 2) Quiz gets stuck on loading, 3) Ads not working, 4) Version text is wrong.
3.  **Agent**: Acknowledges and starts fixing the 4 issues.
4.  **User**: Provides a screen recording video showing the game still not ending and ads not appearing.
5.  **Agent**: Analyzes the video and understands the two remaining critical bugs.
6.  **Agent**: Implements a  based fix for the life system and updates ad components with test IDs and error logging.
7.  **Agent**: (Work in progress, agent was updating  when the session ended).
8.  **PENDING**: User is waiting for a definitive fix for the game-over logic and the non-functional ads, so they can build a new working APK.

**Project Health Check:**
-   **Broken**: The core gameplay loop (game over condition) and monetization (ads) are confirmed to be non-functional in the latest native build tested by the user, rendering the app unusable for its main purpose.
-   **Mocked**: Ad functionality on the web preview is a simple text placeholder.

**3rd Party Integrations**
-   **Google Sheets**: Used as the dynamic data source for all quiz questions and episodes.
-   **Google AdMob**: Integrated for monetization via banner and interstitial ads. Requires a native build with EAS.
-   **MongoDB**: The database for storing user data and scores.

**Testing status**
-   **Testing agent used after significant changes**: YES (Web screenshot agent was used extensively, but it gave misleading results due to the API discrepancy).
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: None.
-   **Known regressions**: The life system and ad functionality worked at some point but are currently broken in the native build.

**Credentials to test flow:**
N/A

**What agent forgot to execute**
- The agent correctly identified the need for platform-specific files for ads but went through several incorrect approaches (, simple  checks) before settling on the correct one, wasting significant time.
- The agent did not initially add robust error handling or fallback logic, leading to repeated failures when the native APK (using the production URL) behaved differently from the web preview (using the local URL).
- The agent did not implement the Vibration feature requested in the settings screen.
- The detailed animations (confetti, sparkle, etc.) from the redesign spec were likely not implemented or, at a minimum, never verified.
</analysis>
